<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>POULTRY Â· luxury dashboard + CRM & REWARDS</title>
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background-color: #0a0a0a;
      color: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    #app {
      width: 100%;
      max-width: 420px;
      height: 780px;
      background: #0f0f0f;
      border-radius: 32px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(212, 175, 55, 0.2);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .glass {
      background: rgba(30, 30, 30, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(212, 175, 55, 0.15);
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 8px 20px -6px rgba(0,0,0,0.6);
    }

    .header {
      padding: 18px 20px 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
      position: relative;
      z-index: 25;
    }
    .header h1 {
      font-size: 1.6rem;
      font-weight: 500;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, #fff 0%, #d4af37 80%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header i {
      font-size: 1.5rem;
      color: #d4af37;
      background: rgba(212, 175, 55, 0.1);
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      transition: 0.2s;
    }
    .header i:active {
      background: rgba(212, 175, 55, 0.3);
    }

    /* three-dots dropdown panel */
    .more-panel {
      position: absolute;
      top: 70px;
      right: 20px;
      width: 240px;
      background: rgba(20, 20, 20, 0.95);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 24px;
      padding: 12px 0;
      box-shadow: 0 20px 35px -8px black;
      z-index: 30;
      display: none;
      flex-direction: column;
    }
    .more-panel.show {
      display: flex;
    }
    .more-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 20px;
      color: #ccc;
      font-size: 1rem;
      border-bottom: 1px solid #2a2a2a;
      transition: 0.15s;
      cursor: pointer;
    }
    .more-item:last-child {
      border-bottom: none;
    }
    .more-item i {
      width: 24px;
      color: #d4af37;
      font-size: 1.2rem;
    }
    .more-item:hover,
    .more-item:active {
      background: rgba(212, 175, 55, 0.1);
      color: #fff;
    }

    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px 80px 16px;
      scrollbar-width: thin;
      scrollbar-color: #d4af37 #1e1e1e;
    }
    .main-content::-webkit-scrollbar {
      width: 4px;
    }
    .main-content::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    .main-content::-webkit-scrollbar-thumb {
      background: #d4af37;
      border-radius: 8px;
    }

    .bottom-nav {
      position: absolute;
      bottom: 0;
      width: 100%;
      max-width: 420px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid rgba(212, 175, 55, 0.3);
      padding: 6px 0 10px 0;
      z-index: 10;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #888;
      font-size: 0.62rem;
      transition: all 0.15s ease;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 30px;
      background: transparent;
      flex: 0 1 auto;
    }
    .nav-item i {
      font-size: 1.3rem;
      margin-bottom: 2px;
    }
    .nav-item.active {
      color: #d4af37;
      background: rgba(212, 175, 55, 0.1);
      text-shadow: 0 0 8px #d4af3740;
    }

    .card {
      background: rgba(20, 20, 20, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 24px;
      padding: 18px 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 20px -10px black;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 500;
      color: #d4af37;
      margin-bottom: 14px;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .stat {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 18px;
      padding: 14px 12px;
      border-left: 3px solid #d4af37;
    }
    .stat-label {
      font-size: 0.75rem;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: white;
      line-height: 1.2;
    }
    .stat-sub {
      font-size: 0.8rem;
      color: #6b8e4c;
    }

    .badge {
      background: #6b8e4c20;
      border: 1px solid #6b8e4c;
      color: #b7d99e;
      padding: 4px 8px;
      border-radius: 40px;
      font-size: 0.7rem;
    }
    .alert-badge {
      background: #b85a3a30;
      border: 1px solid #b85a3a;
      color: #f0a58b;
    }

    .batch-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #2a2a2a;
    }
    .batch-row:last-child { border: none; }
    .batch-info h4 { font-size: 1rem; font-weight: 500; }
    .batch-info p { font-size: 0.75rem; color: #aaa; }
    .batch-numbers { text-align: right; }
    .batch-numbers .quantity { color: #d4af37; font-weight: 600; }

    .btn-gold {
      background: #d4af3720;
      border: 1px solid #d4af37;
      color: #d4af37;
      border-radius: 40px;
      padding: 10px 18px;
      font-weight: 500;
      font-size: 0.9rem;
      width: fit-content;
      backdrop-filter: blur(4px);
      transition: 0.2s;
      cursor: pointer;
    }
    .btn-gold i { margin-right: 6px; }
    .btn-gold:active { background: #d4af3740; }

    .chart-bar {
      background: #2b2b2b;
      height: 8px;
      border-radius: 20px;
      margin: 8px 0;
    }
    .bar-fill {
      height: 8px;
      background: linear-gradient(90deg, #d4af37, #f5e085);
      border-radius: 20px;
      width: 0%;
    }

    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    .gold-text { color: #d4af37; }
    .green-text { color: #6b8e4c; }
    hr { border: 0.5px solid #2a2a2a; margin: 16px 0; }

    .cost-item { display: flex; justify-content: space-between; margin: 12px 0; font-size: 0.95rem; }
    .cost-input {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
    }
    .cost-input label {
      color: #ccc;
      font-size: 0.9rem;
    }
    .cost-input input {
      width: 100px;
      background: #2a2a2a;
      border: 1px solid #d4af3740;
      border-radius: 30px;
      padding: 8px 12px;
      color: #fff;
      font-size: 0.9rem;
      text-align: right;
    }
    .cost-input input:focus {
      outline: none;
      border-color: #d4af37;
    }
    .helper-text {
      font-size: 0.7rem;
      color: #aaa;
      margin-top: 4px;
    }
    .btn-small {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      border-radius: 30px;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      margin-right: 6px;
    }
    .btn-small.active {
      background: #d4af37;
      color: #0a0a0a;
    }
    .flex-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .cards-scroll {
      display: flex;
      overflow-x: auto;
      gap: 12px;
      padding: 4px 0 12px 0;
      scrollbar-width: thin;
      scrollbar-color: #d4af37 #1e1e1e;
    }
    .cards-scroll::-webkit-scrollbar { height: 3px; }
    .cards-scroll::-webkit-scrollbar-track { background: #1e1e1e; }
    .cards-scroll::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 8px; }
    .reward-card {
      min-width: 180px;
      background: #1c1c1c;
      border-radius: 24px;
      padding: 14px;
      border: 1px solid #d4af3740;
    }
    .reward-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    .reward-table th { text-align: left; color: #d4af37; font-weight: 500; padding: 8px 0; }
    .reward-table td { padding: 6px 0; border-bottom: 1px solid #2a2a2a; }

    /* new CRM specific */
    .crm-customer-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #2a2a2a;
    }
    .crm-avatar {
      width: 40px; height: 40px;
      background: #d4af3720;
      border-radius: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #d4af37;
      font-weight: 600;
    }
    .crm-info {
      flex: 1;
    }
    .crm-info h4 { font-size: 0.95rem; font-weight: 500; }
    .crm-info p { font-size: 0.7rem; color: #aaa; }
    .crm-badge {
      font-size: 0.7rem;
      background: #d4af3720;
      padding: 2px 6px;
      border-radius: 30px;
    }
    .filter-row {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 8px;
    }
    .filter-chip {
      background: #2a2a2a;
      border-radius: 30px;
      padding: 6px 12px;
      font-size: 0.75rem;
      white-space: nowrap;
      border: 1px solid transparent;
    }
    .filter-chip.active {
      border-color: #d4af37;
      color: #d4af37;
    }
    .message-preview {
      display: flex;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #2a2a2a;
    }
    .unread-dot {
      width: 10px; height: 10px;
      background: #d4af37;
      border-radius: 50%;
      margin-top: 6px;
    }
    .quick-action-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .quick-action-btn {
      background: #1e1e1e;
      border: 1px solid #d4af3740;
      border-radius: 40px;
      padding: 8px;
      font-size: 0.7rem;
      text-align: center;
      cursor: pointer;
    }
    .quick-action-btn i { color: #d4af37; }
  </style>
</head>
<body>
<div id="app">
  <!-- header with three dots -->
  <div class="header">
    <h1>ğŸ” POULTRY</h1>
    <i class="fas fa-ellipsis-v" id="moreMenuToggle"></i>
  </div>

  <!-- three-dots panel: Settings + Rewards + Infrastructure + NEW CRM -->
  <div class="more-panel" id="morePanel">
    <div class="more-item" data-tab="settings">
      <i class="fas fa-gear"></i> <span>Settings</span>
    </div>
    <div class="more-item" data-tab="rewards">
      <i class="fas fa-gift"></i> <span>Rewards</span>
    </div>
    <div class="more-item" data-tab="infra">
      <i class="fas fa-hard-hat"></i> <span>Infrastructure</span>
    </div>
    <!-- NEW CRM / CUSTOMER SERVICE ITEM -->
    <div class="more-item" data-tab="crm">
      <i class="fas fa-users"></i> <span>Customer</span>
    </div>
  </div>

  <!-- main content area: all panes (original 7 + infra + new CRM) -->
  <div class="main-content" id="mainContent">
    <!-- DASHBOARD PANE (original full content) -->
    <div class="tab-pane active" id="dashboardPane">
      <div class="card">
        <div class="card-title"><i class="fas fa-eye gold-text"></i> live overview</div>
        <div class="grid-2">
          <div class="stat"><span class="stat-label">chickens</span><div class="stat-value" id="totalBirdsDisplay">2,450</div><span class="stat-sub" id="birdsChange">+200 today</span></div>
          <div class="stat"><span class="stat-label">sold today</span><div class="stat-value" id="soldTodayDisplay">128</div><span class="stat-sub" id="revenueTodayDisplay">R 896</span></div>
          <div class="stat"><span class="stat-label">lost</span><div class="stat-value" id="lostTodayDisplay">12</div><span class="stat-sub">â¬‡ï¸ 0.5%</span></div>
          <div class="stat"><span class="stat-label">revenue today</span><div class="stat-value" id="revenueTodayValue">R 1,280</div><span class="stat-sub" id="revenueTodayPercent">+18%</span></div>
        </div>
        <div style="margin-top: 16px;">
          <div style="display: flex; justify-content: space-between;"><span>ğŸ“† monthly revenue</span> <strong class="gold-text" id="monthlyRevenueDisplay">R 324,480</strong></div>
          <div class="chart-bar" style="margin:6px 0 12px;"><div class="bar-fill" style="width:76%"></div></div>
          <div style="display: flex; justify-content: space-between;"><span>ğŸ” remaining stock</span> <strong id="remainingStockDisplay">2,322</strong></div>
          <div style="display: flex; justify-content: space-between;"><span>ğŸ“¦ upcoming batch</span> <strong>650 (in 4d)</strong></div>
          <hr>
          <div style="display: flex; justify-content: space-between; font-size: 1.1rem;"><span>ğŸ“ˆ net profit (month)</span> <strong class="green-text" id="netProfitMonthDisplay">R 86,400</strong></div>
        </div>
      </div>

      <!-- NEW KPI CARD (Admin) -->
      <div class="card">
        <div class="card-title"><i class="fas fa-gauge-high gold-text"></i> key performance indicators</div>
        <div class="grid-2">
          <div class="stat"><span class="stat-label">active birds</span><div class="stat-value" id="kpiActiveBirds">2,322</div></div>
          <div class="stat"><span class="stat-label">mortality %</span><div class="stat-value" id="kpiMortality">0.9%</div></div>
          <div class="stat"><span class="stat-label">avg selling price</span><div class="stat-value" id="kpiAvgPrice">R 84.50</div></div>
          <div class="stat"><span class="stat-label">cost / bird</span><div class="stat-value" id="kpiCostPerBird">R 62.00</div></div>
          <div class="stat"><span class="stat-label">subscription %</span><div class="stat-value" id="kpiSubPct">18%</div></div>
          <div class="stat"><span class="stat-label">byâ€‘product rev</span><div class="stat-value" id="kpiByproduct">R 12,750</div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-chart-line gold-text"></i> weekly trend</div>
        <div style="display: flex; gap: 10px; justify-content: space-between;">
          <span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span><span>S</span>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 6px;">
          <div style="height: 40px; width: 12%; background: #d4af37; border-radius: 12px;"></div>
          <div style="height: 30px; width: 12%; background: #d4af37; border-radius: 12px;"></div>
          <div style="height: 50px; width: 12%; background: #d4af37; border-radius: 12px;"></div>
          <div style="height: 36px; width: 12%; background: #d4af37; border-radius: 12px;"></div>
          <div style="height: 60px; width: 12%; background: #d4af37; border-radius: 12px;"></div>
          <div style="height: 44px; width: 12%; background: #d4af37; border-radius: 12px;"></div>
          <div style="height: 38px; width: 12%; background: #aaa; border-radius: 12px;"></div>
        </div>
        <p class="badge" style="margin-top: 12px;"><i class="fas-regular fa-truck"></i> expansion: new farm in Q3</p>
      </div>

      <!-- Net Profit & Projection Card -->
      <div class="card" id="profitOverviewCard">
        <div class="card-title"><i class="fas fa-coins gold-text"></i> net profit & projection</div>
        <div class="grid-2">
          <div class="stat"><span class="stat-label">net monthly profit</span><div class="stat-value" id="netMonthly">R 86,400</div></div>
          <div class="stat"><span class="stat-label">profit / chicken</span><div class="stat-value" id="profitPerChicken">R 22.50</div></div>
        </div>
        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
          <span>ğŸ“Š 3â€‘month projection</span>
          <strong class="gold-text" id="projectedProfit">R 259,200</strong>
        </div>
        <div class="flex-row" style="margin: 10px 0;">
          <button class="btn-small" data-growth="10">+10% growth</button>
          <button class="btn-small" data-growth="20">+20%</button>
          <button class="btn-small" data-growth="30">+30%</button>
          <span class="helper-text" id="growthHint">simulate</span>
        </div>
        <p class="badge" id="profitTrend"><i class="fas fa-arrow-up"></i> profit trend: +5.2% vs last month</p>
      </div>
    </div>

    <!-- INVENTORY PANE (original full content) -->
    <div class="tab-pane" id="inventoryPane">
      <div class="card">
        <div class="card-title"><i class="fas fa-warehouse gold-text"></i> batch registration</div>
        <div class="batch-row">
          <div class="batch-info"><h4>#B2401 - Cornish</h4><p>purchased 12 Feb | 45 days</p></div>
          <div class="batch-numbers"><span class="quantity">820</span> / 850 <br> <span class="badge">lost 30</span></div>
        </div>
        <div class="batch-row">
          <div class="batch-info"><h4>#B2402 - Ross</h4><p>purchased 28 Feb | 32 days</p></div>
          <div class="batch-numbers"><span class="quantity">1,240</span> / 1,250 <br> <span class="badge">lost 10</span></div>
        </div>
        <div class="batch-row">
          <div class="batch-info"><h4>#B2403 - Free Range</h4><p>arriving 22 Mar</p></div>
          <div class="batch-numbers"><span class="quantity">0</span> / 600 <br> <span class="badge">upcoming</span></div>
        </div>
        <button class="btn-gold" style="margin-top: 16px; width:100%;"><i class="fas fa-plus"></i> register new batch</button>
        <p style="font-size:0.7rem; margin-top:12px;"><i class="fas fa-qrcode gold-text"></i> QR ready Â· scan to update deaths/sales</p>
      </div>
      <div class="card">
        <div class="card-title">âš°ï¸ death tracking (last 7d)</div>
        <p>Batch B2401: 12 deaths <span class="green-text">(-1.4%)</span></p>
        <p>Batch B2402: 8 deaths <span class="green-text">(-0.6%)</span></p>
        <p style="color:#d4af37;">recommend: check ventilation</p>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-flag-checkered gold-text"></i> growth checkpoint</div>
        <div style="display: flex; justify-content: space-between;">
          <span>current profit level:</span>
          <strong class="gold-text" id="currentProfitLevel">R3 (86.4k)</strong>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span>next target:</span>
          <strong id="nextTargetDisplay">R5 (150k)</strong>
        </div>
        <div class="chart-bar" style="margin:10px 0;"><div class="bar-fill" id="profitGapFill" style="width:57%"></div></div>
        <p id="gapText">gap to next level: R 63,600</p>
        <ul style="margin-left:20px; color:#ccc; font-size:0.9rem;">
          <li>âœ“ increase sales volume</li>
          <li>âœ“ reduce feed waste</li>
          <li>â†’ add subscriptions</li>
        </ul>
      </div>
    </div>

    <!-- SALES PANE (original full content) -->
    <div class="tab-pane" id="salesPane">
      <div class="card">
        <div class="card-title"><i class="fas fa-dollar-sign gold-text"></i> today's sales</div>
        <div style="font-size: 2.2rem; font-weight:600;" id="todaySalesQty">128 <span style="font-size:1rem;">chickens</span></div>
        <p id="todaySalesAvgPrice">avg price R 84.50 â†’ <span id="todayRevenueCalc">R 10,816</span> revenue</p>
        <hr>
        <div style="display:flex; gap:10px;">
          <div><span class="stat-label">this month</span><div class="stat-value" id="monthlySold">3,840</div></div>
          <div><span class="stat-label">last month</span><div class="stat-value">3,210</div></div>
        </div>
        <button class="btn-gold" style="margin-top:16px;"><i class="fas fa-plus"></i> add manual sale</button>
      </div>

      <!-- Product Mix Card -->
      <div class="card">
        <div class="card-title"><i class="fas fa-chart-pie gold-text"></i> product mix & pricing (ZAR)</div>
        <div class="cost-input"><label>ğŸ¥© wholesale (bulk) %</label> <input type="number" id="wholesalePct" value="68" min="0" max="100" step="1"></div>
        <div class="cost-input"><label>ğŸª retail (standard) %</label> <input type="number" id="retailPct" value="22" min="0" max="100" step="1"></div>
        <div class="cost-input"><label>ğŸ½ï¸ restaurant (premium) %</label> <input type="number" id="restaurantPct" value="10" min="0" max="100" step="1"></div>
        <div class="cost-item"><span>ğŸ“Š weighted avg price</span> <span class="gold-text" id="weightedAvgPrice">R 84.50</span></div>
        <div class="flex-row" style="margin-top:8px;">
          <span class="badge">live R100 | std R100 | prem R115 | bulk R75</span>
        </div>
        <div class="cost-input"><label>ğŸ” subscription discount %</label> <input type="number" id="subDiscount" value="6" min="0" max="100" step="0.5"></div>
        <div class="cost-input"><label>ğŸ¤ referral discount %</label> <input type="number" id="refDiscount" value="10" min="0" max="100" step="0.5"></div>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-chart-pie gold-text"></i> by customer type</div>
        <div>wholesale <span id="wholesaleVal">68</span>% <div class="chart-bar"><div class="bar-fill" style="width:68%"></div></div></div>
        <div>retail <span id="retailVal">22</span>% <div class="chart-bar"><div class="bar-fill" style="width:22%"></div></div></div>
        <div>restaurant <span id="restaurantVal">10</span>% <div class="chart-bar"><div class="bar-fill" style="width:10%"></div></div></div>
      </div>

      <!-- Revenue Breakdown Card -->
      <div class="card">
        <div class="card-title"><i class="fas fa-chart-simple gold-text"></i> revenue breakdown</div>
        <div class="cost-item"><span>ğŸ” live chickens</span> <span id="revLive">R 163,200</span></div>
        <div class="cost-item"><span>ğŸ— prepared</span> <span id="revPrep">R 41,200</span></div>
        <div class="cost-item"><span>ğŸ“¦ bulk</span> <span id="revBulk">R 97,920</span></div>
        <div class="cost-item"><span>ğŸ”„ byâ€‘products</span> <span id="revByproduct">R 12,750</span></div>
        <div class="cost-item"><span>ğŸŒ± manure sales</span> <span id="revManure">R 3,000</span></div>
        <div class="cost-item" style="border-top:1px solid #333;"><span>ğŸ’° total revenue</span> <span class="gold-text" id="totalRevenue">R 324,480</span></div>
        <div class="cost-item"><span>ğŸ” revenue / chicken</span> <span id="revenuePerChicken">R 84.50</span></div>
      </div>
    </div>

    <!-- LOGISTICS PANE (original full content) -->
    <div class="tab-pane" id="logisticsPane">
      <div class="card">
        <div class="card-title"><i class="fas fa-truck gold-text"></i> active deliveries</div>
        <div class="batch-row"><span>ğŸšš driver: Ahmed</span> <span class="badge">to city market</span></div>
        <div class="batch-row"><span>ğŸšš driver: Sara</span> <span class="badge">feed pickup</span></div>
        <div class="batch-row"><span>â›½ vehicle usage today</span> <span>54 km</span></div>
        <button class="btn-gold" style="width:100%;">assign new delivery</button>
      </div>
      <div class="card">
        <div class="card-title">ğŸŒ¾ feed purchase log</div>
        <p>18 Mar: 2.4t @ R580/t</p>
        <p>12 Mar: 3.0t @ R575/t</p>
        <p style="color:#6b8e4c;">ğŸ“Š optimal reorder: 3 days</p>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-calculator gold-text"></i> feed forecast (month)</div>
        <div class="cost-item"><span>ğŸŒ¾ total feed req.</span> <span id="totalFeedKg">11,025 kg</span></div>
        <div class="cost-item"><span>ğŸ›ï¸ bags (50kg)</span> <span id="feedBags">221 bags</span></div>
        <div class="cost-item"><span>ğŸ’° estimated cost</span> <span id="feedCostEstimate">R 85,085</span></div>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-rocket gold-text"></i> expansion triggers</div>
        <div id="triggerSuggestions"><p>ğŸš€ next: vehicle at R40,000</p></div>
        <p class="badge" id="triggerProgress">you are 216% toward vehicle trigger</p>
        <button class="btn-gold" style="margin-top:8px; width:100%;">customize triggers</button>
      </div>
    </div>

    <!-- BUDGET PANE (original full content) -->
    <div class="tab-pane" id="budgetPane">
      <div class="card">
        <div class="card-title"><i class="fas fa-coins gold-text"></i> P&L summary (ZAR)</div>
        <div class="cost-item"><span>ğŸ” chicken cost</span> <span id="plChickens">R 34,300</span></div>
        <div class="cost-item"><span>ğŸŒ¾ feed cost</span> <span id="plFeed">R 85,085</span></div>
        <div class="cost-item"><span>ğŸšš logistics</span> <span id="plLogistics">R 4,300</span></div>
        <div class="cost-item"><span>ğŸ‘©â€ğŸŒ¾ labor</span> <span id="plLabor">R 6,500</span></div>
        <div class="cost-item" style="border-top:1px solid #333; margin-top:8px; padding-top:8px;">
          <span class="gold-text">ğŸ’° revenue</span> <span id="plRevenue">R 324,480</span>
        </div>
        <div class="cost-item"><span>ğŸ“ˆ profit margin</span> <span class="green-text" id="plMargin">26.6% (R 86,400)</span></div>
      </div>

      <!-- Monthly cost tracker -->
      <div class="card">
        <div class="card-title"><i class="fas fa-calculator gold-text"></i> monthly cost tracker</div>
        <div class="cost-input"><label>ğŸ¤ chicks purchased</label> <input type="number" id="chicksCost" value="34300" step="100"></div>
        <div class="cost-input"><label>ğŸŒ¾ feed cost</label> <input type="number" id="feedCost" value="85085" step="100"></div>
        <div class="cost-input"><label>ğŸšš transport</label> <input type="number" id="transportCost" value="4300" step="100"></div>
        <div class="cost-input"><label>ğŸ‘©â€ğŸŒ¾ labor</label> <input type="number" id="laborCost" value="6500" step="100"></div>
        <div class="cost-input"><label>âš¡ utilities</label> <input type="number" id="utilitiesCost" value="2100" step="100"></div>
        <div class="cost-input"><label>ğŸ”§ equipment</label> <input type="number" id="equipmentCost" value="900" step="100"></div>
        <div class="cost-input"><label>ğŸ’€ losses</label> <input type="number" id="lossesCost" value="600" step="100"></div>
        <hr>
        <div class="cost-input"><label>ğŸ” adjustable cost/bird</label> <input type="number" id="adjustableCostPerBird" value="62" step="0.5"></div>
        <div class="cost-item"><span>ğŸ“‰ total expenses</span> <span class="gold-text" id="totalExpenses">R 133,785</span></div>
        <div class="cost-item"><span>ğŸ” cost per chicken</span> <span id="costPerChicken">R 34.84</span></div>
      </div>

      <div class="card">
        <div class="card-title">âš¡ optimization suggestions</div>
        <ul style="margin-left:20px; color:#ccc;">
          <li>ğŸ” batch B2402 has lowest mortality â€“ replicate conditions</li>
          <li>ğŸš› combine city deliveries to save 12% fuel</li>
          <li>ğŸŒ¾ buy feed before April price hike</li>
        </ul>
      </div>

      <!-- Efficiency monitor -->
      <div class="card">
        <div class="card-title"><i class="fas fa-gauge-high gold-text"></i> efficiency monitor</div>
        <div class="cost-item"><span>ğŸŒ¾ feed / chicken</span> <span>4.5 kg</span></div>
        <div class="cost-item"><span>ğŸ’€ death rate</span> <span id="deathRateDisplay">0.9%</span></div>
        <div class="cost-item"><span>ğŸ‘©â€ğŸŒ¾ labor cost / bird</span> <span id="laborPerBird">R 1.69</span></div>
        <div class="cost-item"><span>ğŸ’° profit / worker</span> <span id="profitPerWorker">R 28,800</span></div>
        <p class="badge" style="margin-top:6px;">âš ï¸ feed usage above optimal</p>
      </div>
    </div>

    <!-- SETTINGS PANE (original full content) -->
    <div class="tab-pane" id="settingsPane">
      <div class="card">
        <div class="card-title"><i class="fas fa-sliders-h gold-text"></i> farm profile</div>
        <p><i class="fas fa-user"></i> Owner: Rana family</p>
        <p><i class="fas fa-location-dot"></i> Main farm + 1 expansion</p>
        <p><i class="fas fa-users"></i> Users: admin, brother, mother, driver</p>
        <hr>
        <p><i class="fas fa-cloud-sun"></i> multiâ€‘location ready</p>
        <p><i class="fas fa-qrcode"></i> QR batch scanning active</p>
        <button class="btn-gold" style="width:100%;"><i class="fas fa-link"></i> connect supabase</button>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-gears gold-text"></i> expansion triggers (ZAR)</div>
        <div class="cost-input"><label>ğŸš› vehicle trigger</label> <input type="number" id="vehicleTrigger" value="40000" step="1000"></div>
        <div class="cost-input"><label>ğŸ“¦ stock expansion</label> <input type="number" id="stockTrigger" value="60000" step="1000"></div>
        <div class="cost-input"><label>ğŸ­ new farm</label> <input type="number" id="farmTrigger" value="100000" step="1000"></div>
        <button class="btn-gold" style="margin-top:8px;">save triggers</button>
      </div>

      <!-- by-product toggle -->
      <div class="card">
        <div class="card-title"><i class="fas fa-toggle-on gold-text"></i> byâ€‘product settings</div>
        <div class="cost-input"><label>ğŸ’© byâ€‘product rev/bird</label> <input type="number" id="byproductPerBird" value="85" step="5"></div>
        <div class="flex-row"><span class="badge">applies to standard/bulk</span></div>
      </div>
    </div>

    <!-- REWARDS PANE (original full content) -->
    <div class="tab-pane" id="rewardsPane">
      <!-- KPI cards -->
      <div class="card">
        <div class="card-title"><i class="fas fa-trophy gold-text"></i> rewards KPIs</div>
        <div class="grid-2">
          <div class="stat"><span class="stat-label">claimed this month</span><div class="stat-value" id="rewardsClaimed">8</div></div>
          <div class="stat"><span class="stat-label">active rewards</span><div class="stat-value" id="activeRewards">12</div></div>
          <div class="stat"><span class="stat-label">upcoming</span><div class="stat-value" id="upcomingRewards">5</div></div>
          <div class="stat"><span class="stat-label">byâ€‘product bonus</span><div class="stat-value" id="byproductBonusUptake">3</div></div>
          <div class="stat"><span class="stat-label">referral credits</span><div class="stat-value" id="referralCredits">R 1,240</div></div>
        </div>
      </div>

      <!-- admin controls -->
      <div class="card">
        <div class="card-title"><i class="fas fa-sliders-h gold-text"></i> reward rules (admin)</div>
        <div class="cost-input"><label>âœ… enable rewards</label> <input type="checkbox" id="enableRewards" checked style="width:20px;"></div>
        <div class="cost-input"><label>ğŸ” chickens per reward</label> <input type="number" id="chickensPerReward" value="10" min="1" step="1"></div>
        <div class="cost-input"><label>ğŸ“… streak days</label> <input type="number" id="streakDays" value="7" min="1"></div>
        <div class="cost-input"><label>ğŸ’° discount %</label> <input type="number" id="rewardDiscount" value="8" min="0" max="100" step="0.5"></div>
        <div class="cost-input"><label>ğŸ” double byâ€‘product day</label> <input type="checkbox" id="doubleByproduct" checked></div>
        <div class="cost-input"><label>ğŸ‘¥ referral credit (R)</label> <input type="number" id="referralCreditValue" value="50" step="5"></div>
        <button class="btn-small" id="simulatePurchaseBtn" style="margin-top:6px;"><i class="fas fa-cart-plus"></i> simulate purchase</button>
      </div>

      <!-- swipeable reward cards -->
      <div class="card">
        <div class="card-title"><i class="fas fa-id-card gold-text"></i> active rewards (swipe)</div>
        <div class="cards-scroll" id="rewardCardsContainer">
          <!-- dynamically filled -->
        </div>
      </div>

      <!-- rewards table -->
      <div class="card reward-table">
        <div class="card-title"><i class="fas fa-table gold-text"></i> all customer rewards</div>
        <div style="overflow-x:auto;">
          <table>
            <thead><tr><th>Customer</th><th>Type</th><th>Progress</th><th>Status</th><th>Expiry</th><th>Discount</th></tr></thead>
            <tbody id="rewardsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- INFRASTRUCTURE PANE (original full content) -->
    <div class="tab-pane" id="infraPane">
      <!-- 1. Infrastructure status & growth trigger -->
      <div class="card">
        <div class="card-title"><i class="fas fa-chart-line gold-text"></i> capacity vs demand</div>
        <div class="grid-2">
          <div class="stat"><span class="stat-label">current capacity (birds)</span><div class="stat-value"><input type="number" id="currentCapacity" value="2500" min="0" step="100" style="width:100px; background:#2a2a2a; border:none; color:white; font-size:1.2rem;"></div></div>
          <div class="stat"><span class="stat-label">proj. monthly demand</span><div class="stat-value"><input type="number" id="projectedDemand" value="2800" min="0" step="100" style="width:100px; background:#2a2a2a; border:none; color:white; font-size:1.2rem;"></div></div>
        </div>
        <div class="cost-item"><span>ğŸ“Š utilization</span> <span id="capacityUtilization" class="gold-text">89%</span></div>
        <div id="infraSuggestion" class="badge" style="margin-top:8px;">âš™ï¸ infrastructure upgrade suggested (40% of profit)</div>
        <div class="cost-item"><span>ğŸ—ï¸ estimated upgrade investment</span> <span id="requiredInvestment">R 0</span></div>
        <p class="helper-text" id="upgradeDetails">units, feeders, water, climate, tech</p>
      </div>

      <!-- 2. Emergency fund & categories -->
      <div class="card">
        <div class="card-title"><i class="fas fa-shield-halved gold-text"></i> emergency fund</div>
        <div class="cost-input"><label>ğŸ’° current balance</label> <input type="number" id="emergencyBalance" value="15000" step="1000"></div>
        <div class="cost-input"><label>âš ï¸ minimum threshold</label> <input type="number" id="emergencyMin" value="20000" step="1000"></div>
        <div id="emergencyAlert" class="badge alert-badge" style="margin-top:6px;">âš ï¸ below minimum!</div>
        <hr>
        <div class="card-title" style="margin-top:0;">ğŸ“¦ budget categories (% of remaining after infra)</div>
        <div class="cost-input"><label>ğŸ”§ equipment</label> <input type="number" id="catEquipment" value="30" min="0" max="100" step="1"></div>
        <div class="cost-input"><label>ğŸ› ï¸ new tooling</label> <input type="number" id="catTooling" value="20" min="0" max="100" step="1"></div>
        <div class="cost-input"><label>ğŸšš logistics</label> <input type="number" id="catLogistics" value="25" min="0" max="100" step="1"></div>
        <div class="cost-input"><label>ğŸ“¦ packaging/marketing</label> <input type="number" id="catPackaging" value="25" min="0" max="100" step="1"></div>
        <p class="helper-text" id="catSum" style="color:#d4af37;">total 100%</p>
      </div>

      <!-- 3. Dynamic allocation result (based on monthly profit) -->
      <div class="card">
        <div class="card-title"><i class="fas fa-scale-balanced gold-text"></i> this month's allocation</div>
        <div class="cost-item"><span>ğŸ“ˆ available profit (month)</span> <span id="availProfit">R 86,400</span></div>
        <div class="cost-item"><span>ğŸ—ï¸ infrastructure (40% if needed)</span> <span id="allocInfra">R 34,560</span></div>
        <div class="cost-item"><span>ğŸ†˜ emergency topâ€‘up</span> <span id="allocEmergency">R 5,000</span></div>
        <div class="cost-item"><span>ğŸ”§ equipment</span> <span id="allocEquipment">R 0</span></div>
        <div class="cost-item"><span>ğŸ› ï¸ tooling</span> <span id="allocTooling">R 0</span></div>
        <div class="cost-item"><span>ğŸšš logistics</span> <span id="allocLogistics">R 0</span></div>
        <div class="cost-item"><span>ğŸ“¦ packaging</span> <span id="allocPackaging">R 0</span></div>
        <button class="btn-small" id="recalcAllocBtn"><i class="fas fa-sync-alt"></i> recalc from current profit</button>
      </div>

      <!-- 4. Longâ€‘term planning goals -->
      <div class="card">
        <div class="card-title"><i class="fas fa-tree gold-text"></i> longâ€‘term goals</div>
        <div class="cost-input"><label>ğŸï¸ land acquisition</label> <input type="number" id="goalLand" value="250000" step="1000"></div>
        <div class="cost-input"><label>ğŸ­ facility expansion</label> <input type="number" id="goalFacility" value="180000" step="1000"></div>
        <div class="cost-input"><label>âš™ï¸ new machinery</label> <input type="number" id="goalMachinery" value="95000" step="1000"></div>
        <div class="cost-input"><label>ğŸ“… timeline (months)</label> <input type="number" id="goalTimeline" value="12" min="1"></div>
        <hr>
        <div class="cost-item"><span>ğŸ“Š total investment</span> <span id="totalGoals">R 525,000</span></div>
        <div class="cost-item"><span>ğŸ“† monthly requirement</span> <span id="monthlyGoalReq">R 43,750</span></div>
        <div class="cost-item"><span>ğŸ“ˆ impact on profit</span> <span id="profitAfterGoals">R 42,650</span></div>
      </div>

      <!-- 5. Yearâ€‘end rollover & alerts -->
      <div class="card">
        <div class="card-title"><i class="fas fa-calendar-check gold-text"></i> emergency fund cycle</div>
        <p class="helper-text">yearâ€‘end: if unused >0, 40% reinvested, 60% rolls over</p>
        <button class="btn-gold" id="simulateYearEndBtn"><i class="fas fa-rotate-right"></i> simulate yearâ€‘end rollover</button>
        <div id="rolloverSummary" style="margin-top:12px; font-size:0.9rem;"></div>
        <div id="yearEndAlert" class="badge" style="margin-top:8px;"></div>
      </div>

      <!-- notifications / alerts (dynamic) -->
      <div class="card" style="background:#2a2a2a50;">
        <div class="card-title"><i class="fas fa-bell gold-text"></i> live alerts</div>
        <div id="infraNotifications">
          <p class="badge alert-badge">âš ï¸ capacity nearing limit (consider upgrade)</p>
          <p class="badge alert-badge">âš ï¸ emergency fund below minimum</p>
        </div>
      </div>
    </div>

    <!-- ========== NEW CRM / CUSTOMER SERVICE PANE ========== -->
    <div class="tab-pane" id="crmPane">
      <!-- Customer Overview -->
      <div class="card">
        <div class="card-title"><i class="fas fa-users gold-text"></i> customer overview</div>
        <div class="grid-2">
          <div class="stat"><span class="stat-label">oneâ€‘time</span><div class="stat-value">42</div><span class="stat-sub">18% revenue</span></div>
          <div class="stat"><span class="stat-label">bulk buyers</span><div class="stat-value">18</div><span class="stat-sub">52% revenue</span></div>
          <div class="stat"><span class="stat-label">subscribers</span><div class="stat-value">12</div><span class="stat-sub">30% revenue</span></div>
          <div class="stat"><span class="stat-label">total customers</span><div class="stat-value">72</div><span class="stat-sub">+8 this month</span></div>
        </div>
        <div class="cards-scroll" style="margin-top: 12px;">
          <div class="reward-card" style="min-width:160px;">
            <div class="crm-avatar">JD</div>
            <h4>John Doe</h4>
            <p>â­ 340 pts Â· last: 12 Mar</p>
            <span class="crm-badge">bulk</span> <span class="crm-badge">R 12k</span>
          </div>
          <div class="reward-card" style="min-width:160px;">
            <div class="crm-avatar">SW</div>
            <h4>Spier Wines</h4>
            <p>ğŸ† 1,200 pts Â· last: 15 Mar</p>
            <span class="crm-badge">subscriber</span> <span class="crm-badge">R 45k</span>
          </div>
          <div class="reward-card" style="min-width:160px;">
            <div class="crm-avatar">MT</div>
            <h4>Mama's Take</h4>
            <p>â­ 80 pts Â· last: 10 Mar</p>
            <span class="crm-badge">oneâ€‘time</span> <span class="crm-badge">R 2k</span>
          </div>
        </div>
      </div>

      <!-- Customer Requests & Complaints -->
      <div class="card">
        <div class="card-title"><i class="fas fa-headset gold-text"></i> requests & complaints</div>
        <div class="filter-row">
          <span class="filter-chip active">all</span>
          <span class="filter-chip">open</span>
          <span class="filter-chip">in progress</span>
          <span class="filter-chip">resolved</span>
          <span class="filter-chip">high priority</span>
        </div>
        <div class="batch-row">
          <div><i class="fas fa-exclamation-circle" style="color:#b85a3a;"></i> <strong>Refund</strong> <span class="badge">high</span></div>
          <div><span>#O-3421 Â· John D.</span><br><small>open, assigned to you</small></div>
        </div>
        <div class="batch-row">
          <div><i class="fas fa-question-circle" style="color:#d4af37;"></i> <strong>Query</strong> <span class="badge">medium</span></div>
          <div><span>#O-3419 Â· Spier</span><br><small>in progress (Ahmed)</small></div>
        </div>
        <div class="batch-row">
          <div><i class="fas fa-comment-dots" style="color:#6b8e4c;"></i> <strong>Complaint</strong> <span class="badge">low</span></div>
          <div><span>#O-3415 Â· Mama's</span><br><small>resolved</small></div>
        </div>
      </div>

      <!-- Inbox / Messaging -->
      <div class="card">
        <div class="card-title"><i class="fas fa-inbox gold-text"></i> inbox <span class="badge" style="margin-left:8px;">3 unread</span></div>
        <div class="message-preview">
          <div class="unread-dot"></div>
          <div><strong>Spier Wines</strong> <span style="font-size:0.7rem; color:#aaa;">about order #O-3422</span><br>â€œWhen will the bulk delivery arrive?...â€</div>
        </div>
        <div class="message-preview">
          <div class="unread-dot"></div>
          <div><strong>John Doe</strong> <span style="font-size:0.7rem; color:#aaa;">refund #R-12</span><br>â€œI haven't received my refund yet...â€</div>
        </div>
        <div class="message-preview">
          <div></div>
          <div><strong>Kyle's Grill</strong> <span style="font-size:0.7rem; color:#aaa;">invoice</span><br>â€œThanks for the quick response!â€</div>
        </div>
        <div class="flex-row" style="margin-top:8px;">
          <button class="btn-small"><i class="fas fa-reply"></i> reply</button>
          <button class="btn-small"><i class="fas fa-file-alt"></i> templates</button>
        </div>
      </div>

      <!-- Reviews & Ratings -->
      <div class="card">
        <div class="card-title"><i class="fas fa-star gold-text"></i> reviews & ratings</div>
        <div class="grid-2">
          <div class="stat"><span class="stat-label">avg rating</span><div class="stat-value">4.6 â˜…</div></div>
          <div class="stat"><span class="stat-label">trend (month)</span><div class="stat-value">+0.2</div></div>
        </div>
        <div class="batch-row">
          <div><span>Spier Wines:</span> â€œExcellent qualityâ€ â˜…â˜…â˜…â˜…â˜…</div>
          <button class="btn-small">respond</button>
        </div>
        <div class="batch-row">
          <div><span>Mama's Take:</span> â€œLate deliveryâ€ â˜…â˜…â˜…</div>
          <button class="btn-small">respond</button>
        </div>
      </div>

      <!-- Rewards Integration & Analytics -->
      <div class="card">
        <div class="card-title"><i class="fas fa-gift gold-text"></i> rewards & KPIs</div>
        <div class="grid-2">
          <div class="stat"><span class="stat-label">claimed</span><div class="stat-value">8</div></div>
          <div class="stat"><span class="stat-label">active</span><div class="stat-value">12</div></div>
          <div class="stat"><span class="stat-label">complaint rate</span><div class="stat-value">4.2%</div></div>
          <div class="stat"><span class="stat-label">avg resolution</span><div class="stat-value">2.3d</div></div>
        </div>
        <hr>
        <div class="cost-item"><span>ğŸ“ˆ retention rate</span> <span class="gold-text">78%</span></div>
        <div class="cost-item"><span>ğŸ† top spender</span> <span>Spier Wines (R 45k)</span></div>
        <div class="cost-item"><span>â­ most loyal</span> <span>Kyle's Grill (8 orders)</span></div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-title"><i class="fas fa-bolt gold-text"></i> quick actions</div>
        <div class="quick-action-grid">
          <div class="quick-action-btn"><i class="fas fa-undo-alt"></i> approve refund</div>
          <div class="quick-action-btn"><i class="fas fa-tag"></i> issue reward</div>
          <div class="quick-action-btn"><i class="fas fa-arrow-up"></i> upgrade sub</div>
          <div class="quick-action-btn"><i class="fas fa-pen"></i> add note</div>
          <div class="quick-action-btn"><i class="fas fa-envelope"></i> bulk msg</div>
          <div class="quick-action-btn"><i class="fas fa-tags"></i> tag customer</div>
        </div>
      </div>
    </div>
  </div>

  <!-- bottom navigation (unchanged, 5 items) -->
  <div class="bottom-nav">
    <div class="nav-item active" data-tab="dashboard"><i class="fas fa-chart-pie"></i><span>Home</span></div>
    <div class="nav-item" data-tab="inventory"><i class="fas fa-egg"></i><span>Stock</span></div>
    <div class="nav-item" data-tab="sales"><i class="fas fa-cash-register"></i><span>Sales</span></div>
    <div class="nav-item" data-tab="logistics"><i class="fas fa-truck"></i><span>Logistics</span></div>
    <div class="nav-item" data-tab="budget"><i class="fas fa-chart-line"></i><span>Budget</span></div>
  </div>
</div>

<!-- ORIGINAL DASHBOARD SCRIPT (full, unchanged, but added crm pane to panes) -->
<script>
  (function() {
    // ----- tab switching (updated with crm) -----
    const navItems = document.querySelectorAll('.nav-item');
    const panes = {
      dashboard: document.getElementById('dashboardPane'),
      inventory: document.getElementById('inventoryPane'),
      sales: document.getElementById('salesPane'),
      logistics: document.getElementById('logisticsPane'),
      budget: document.getElementById('budgetPane'),
      settings: document.getElementById('settingsPane'),
      rewards: document.getElementById('rewardsPane'),
      infra: document.getElementById('infraPane'),
      crm: document.getElementById('crmPane')   // NEW CRM PANE
    };

    function setActiveTab(tabId) {
      navItems.forEach(item => item.classList.remove('active'));
      Object.values(panes).forEach(pane => pane.classList.remove('active'));
      const activeNav = Array.from(navItems).find(item => item.dataset.tab === tabId);
      if (activeNav) activeNav.classList.add('active');
      if (panes[tabId]) panes[tabId].classList.add('active');
      document.getElementById('morePanel').classList.remove('show');
    }

    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        const tabId = item.dataset.tab;
        setActiveTab(tabId);
      });
    });

    // ----- three-dots menu handling -----
    const moreToggle = document.getElementById('moreMenuToggle');
    const morePanel = document.getElementById('morePanel');

    moreToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      morePanel.classList.toggle('show');
    });

    document.querySelectorAll('.more-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const tabId = item.dataset.tab; // 'settings', 'rewards', 'infra', 'crm'
        setActiveTab(tabId);
      });
    });

    document.addEventListener('click', (e) => {
      if (!morePanel.contains(e.target) && !moreToggle.contains(e.target)) {
        morePanel.classList.remove('show');
      }
    });

    // ----- rewards data & settings (identical to original) -----
    let rewardsData = [
      { customerId: 101, name: 'Spier Wines', type: 'bulk discount', progress: 8, target: 10, status: 'active', expiry: '2025-04-15', discount: 8, byproductBoost: true, referralCredit: 0 },
      { customerId: 102, name: 'Kyleâ€™s Grill', type: 'premium', progress: 5, target: 7, status: 'active', expiry: '2025-03-30', discount: 5, byproductBoost: false, referralCredit: 0 },
      { customerId: 103, name: 'Thabo Fresh', type: 'referral', progress: 2, target: 3, status: 'active', expiry: '2025-04-10', discount: 10, byproductBoost: false, referralCredit: 50 },
      { customerId: 104, name: 'Lynnâ€™s Table', type: 'by-product bonus', progress: 6, target: 6, status: 'claimed', expiry: '2025-03-22', discount: 8, byproductBoost: true, referralCredit: 0 },
      { customerId: 105, name: 'Mamaâ€™s Takeaways', type: 'streak', progress: 7, target: 7, status: 'upcoming', expiry: '2025-04-01', discount: 12, byproductBoost: false, referralCredit: 0 }
    ];

    let rewardSettings = {
      enabled: true,
      chickensPerReward: 10,
      streakDays: 7,
      baseDiscount: 8,
      doubleByproduct: true,
      referralCredit: 50
    };

    // DOM elements for rewards pane
    const rewardsClaimedSpan = document.getElementById('rewardsClaimed');
    const activeRewardsSpan = document.getElementById('activeRewards');
    const upcomingRewardsSpan = document.getElementById('upcomingRewards');
    const byproductBonusSpan = document.getElementById('byproductBonusUptake');
    const referralCreditsSpan = document.getElementById('referralCredits');
    const rewardCardsContainer = document.getElementById('rewardCardsContainer');
    const rewardsTableBody = document.getElementById('rewardsTableBody');

    // admin inputs
    const enableRewardsChk = document.getElementById('enableRewards');
    const chickensPerRewardInp = document.getElementById('chickensPerReward');
    const streakDaysInp = document.getElementById('streakDays');
    const rewardDiscountInp = document.getElementById('rewardDiscount');
    const doubleByproductChk = document.getElementById('doubleByproduct');
    const referralCreditInp = document.getElementById('referralCreditValue');
    const simulatePurchaseBtn = document.getElementById('simulatePurchaseBtn');

    function updateRewardsUI() {
      const claimed = rewardsData.filter(r => r.status === 'claimed').length;
      const active = rewardsData.filter(r => r.status === 'active').length;
      const upcoming = rewardsData.filter(r => r.status === 'upcoming').length;
      const byproductUptake = rewardsData.filter(r => r.byproductBoost && r.status === 'active').length;
      const totalReferral = rewardsData.reduce((acc, r) => acc + (r.referralCredit || 0), 0);
      rewardsClaimedSpan.innerText = claimed;
      activeRewardsSpan.innerText = active;
      upcomingRewardsSpan.innerText = upcoming;
      byproductBonusSpan.innerText = byproductUptake;
      referralCreditsSpan.innerText = 'R ' + totalReferral.toLocaleString();

      let cardsHtml = '';
      rewardsData.filter(r => r.status === 'active' || r.status === 'upcoming').forEach(r => {
        cardsHtml += `<div class="reward-card"><small>${r.name}</small><br><strong>${r.type}</strong><br>ğŸ“Š ${r.progress}/${r.target}<br>${r.status} Â· ${r.expiry}<br>ğŸ’° ${r.discount}% disc</div>`;
      });
      rewardCardsContainer.innerHTML = cardsHtml || '<div class="reward-card">no active rewards</div>';

      let rows = '';
      rewardsData.forEach(r => {
        rows += `<tr><td>${r.name}</td><td>${r.type}</td><td>${r.progress}/${r.target}</td><td>${r.status}</td><td>${r.expiry}</td><td>${r.discount}%</td></tr>`;
      });
      rewardsTableBody.innerHTML = rows;
    }

    function getActiveRewardDiscountRate() {
      if (!rewardSettings.enabled) return 0;
      const activeRewards = rewardsData.filter(r => r.status === 'active');
      if (activeRewards.length === 0) return 0;
      const totalDisc = activeRewards.reduce((acc, r) => acc + r.discount, 0);
      return totalDisc / activeRewards.length / 100;
    }

    function getReferralCreditTotal() {
      return rewardsData.reduce((acc, r) => acc + (r.referralCredit || 0), 0);
    }

    function getByproductBoostFactor() {
      if (!rewardSettings.doubleByproduct) return 1;
      const activeBoost = rewardsData.filter(r => r.byproductBoost && r.status === 'active').length;
      return 1 + (activeBoost * 0.1);
    }

    // ---------- BUSINESS INTELLIGENCE LOGIC (with rewards) ----------
    const TOTAL_BIRDS = 2450;
    const SOLD_TODAY = 128;
    const MONTHLY_SOLD = 3840;
    const MORTALITY_RATE = 0.009;

    const chicksInput = document.getElementById('chicksCost');
    const feedInput = document.getElementById('feedCost');
    const transportInput = document.getElementById('transportCost');
    const laborInput = document.getElementById('laborCost');
    const utilitiesInput = document.getElementById('utilitiesCost');
    const equipmentInput = document.getElementById('equipmentCost');
    const lossesInput = document.getElementById('lossesCost');
    const adjustableCostPerBird = document.getElementById('adjustableCostPerBird');
    const wholesalePct = document.getElementById('wholesalePct');
    const retailPct = document.getElementById('retailPct');
    const restaurantPct = document.getElementById('restaurantPct');
    const subDiscount = document.getElementById('subDiscount');
    const refDiscount = document.getElementById('refDiscount');
    const byproductPerBirdInput = document.getElementById('byproductPerBird');
    const vehicleTrigger = document.getElementById('vehicleTrigger');
    const stockTrigger = document.getElementById('stockTrigger');
    const farmTrigger = document.getElementById('farmTrigger');

    const PRICE_LIVE = 100, PRICE_STANDARD = 100, PRICE_PREMIUM = 115, PRICE_BULK = 75;

    function computeAvgPrice() {
      let wp = parseFloat(wholesalePct.value) || 0;
      let rp = parseFloat(retailPct.value) || 0;
      let rest = parseFloat(restaurantPct.value) || 0;
      let total = wp + rp + rest;
      if (total === 0) return 84.5;
      return (wp * PRICE_BULK + rp * PRICE_STANDARD + rest * PRICE_PREMIUM) / total;
    }

    function getByproductRevenue() {
      let byPerBird = parseFloat(byproductPerBirdInput.value) || 85;
      let wp = parseFloat(wholesalePct.value) || 68;
      let rp = parseFloat(retailPct.value) || 22;
      let applicableBirds = MONTHLY_SOLD * (wp + rp) / 100;
      return applicableBirds * byPerBird;
    }

    function updateAll() {
      const chicks = parseFloat(chicksInput.value) || 0;
      const feed = parseFloat(feedInput.value) || 0;
      const transport = parseFloat(transportInput.value) || 0;
      const labor = parseFloat(laborInput.value) || 0;
      const utilities = parseFloat(utilitiesInput.value) || 0;
      const equipment = parseFloat(equipmentInput.value) || 0;
      const losses = parseFloat(lossesInput.value) || 0;
      const totalCost = chicks + feed + transport + labor + utilities + equipment + losses;

      const adjCostPerBird = parseFloat(adjustableCostPerBird.value) || 62;
      const avgPrice = computeAvgPrice();
      let byproductRev = getByproductRevenue();

      const discountRate = getActiveRewardDiscountRate();
      const referralTotal = getReferralCreditTotal();
      const boostFactor = getByproductBoostFactor();
      byproductRev = byproductRev * boostFactor;

      const monthlyRevenueBase = MONTHLY_SOLD * avgPrice;
      const discountAmount = monthlyRevenueBase * discountRate;
      const monthlyRevenue = monthlyRevenueBase - discountAmount - referralTotal;
      const revenueToday = SOLD_TODAY * avgPrice * (1 - discountRate);

      const netProfit = monthlyRevenue + byproductRev - totalCost;

      document.getElementById('totalRevenue').innerText = 'R ' + (monthlyRevenue + byproductRev).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      document.getElementById('revenuePerChicken').innerText = 'R ' + avgPrice.toFixed(2);
      document.getElementById('monthlyRevenueDisplay').innerText = 'R ' + (monthlyRevenue + byproductRev).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      document.getElementById('revenueTodayValue').innerText = 'R ' + revenueToday.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      document.getElementById('revenueTodayDisplay').innerText = 'R ' + revenueToday.toFixed(0);
      document.getElementById('netMonthly').innerText = 'R ' + netProfit.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      document.getElementById('profitPerChicken').innerText = 'R ' + (netProfit / MONTHLY_SOLD).toFixed(2);
      document.getElementById('weightedAvgPrice').innerText = 'R ' + avgPrice.toFixed(2);
      document.getElementById('todaySalesAvgPrice').innerHTML = `avg price R ${avgPrice.toFixed(2)} â†’ <span id="todayRevenueCalc">R ${revenueToday.toFixed(0)}</span> revenue`;
      document.getElementById('todayRevenueCalc').innerText = 'R ' + revenueToday.toFixed(0);
      document.getElementById('totalExpenses').innerText = 'R ' + totalCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      document.getElementById('costPerChicken').innerText = 'R ' + (totalCost / MONTHLY_SOLD).toFixed(2);

      const revenueLive = MONTHLY_SOLD * (parseFloat(wholesalePct.value)/100) * PRICE_BULK;
      const revenuePrep = MONTHLY_SOLD * (parseFloat(retailPct.value)/100) * PRICE_STANDARD;
      const revenueBulk = MONTHLY_SOLD * (parseFloat(restaurantPct.value)/100) * PRICE_PREMIUM;
      document.getElementById('revLive').innerText = 'R ' + revenueLive.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      document.getElementById('revPrep').innerText = 'R ' + revenuePrep.toFixed(0);
      document.getElementById('revBulk').innerText = 'R ' + revenueBulk.toFixed(0);
      document.getElementById('revByproduct').innerText = 'R ' + byproductRev.toFixed(0);
      document.getElementById('revManure').innerText = 'R 3,000';

      document.getElementById('kpiActiveBirds').innerText = (TOTAL_BIRDS * (1 - MORTALITY_RATE)).toFixed(0);
      document.getElementById('kpiMortality').innerText = (MORTALITY_RATE * 100).toFixed(1) + '%';
      document.getElementById('kpiAvgPrice').innerText = 'R ' + avgPrice.toFixed(2);
      document.getElementById('kpiCostPerBird').innerText = 'R ' + adjCostPerBird.toFixed(2);
      document.getElementById('kpiSubPct').innerText = '18%';
      document.getElementById('kpiByproduct').innerText = 'R ' + byproductRev.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

      document.getElementById('plChickens').innerText = 'R ' + chicks.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      document.getElementById('plFeed').innerText = 'R ' + feed.toFixed(0);
      document.getElementById('plLogistics').innerText = 'R ' + transport.toFixed(0);
      document.getElementById('plLabor').innerText = 'R ' + labor.toFixed(0);
      document.getElementById('plRevenue').innerText = 'R ' + (monthlyRevenue + byproductRev).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      const margin = ((netProfit) / (monthlyRevenue + byproductRev) * 100).toFixed(1);
      document.getElementById('plMargin').innerHTML = `${margin}% (R ${netProfit.toFixed(0)})`;

      const netProfitNum = netProfit;
      document.getElementById('projectedProfit').innerText = 'R ' + (netProfitNum * 3).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      let level = 'R1';
      if (netProfitNum >= 80000) level = 'R5 (80k+)';
      else if (netProfitNum >= 50000) level = 'R4 (50k)';
      else if (netProfitNum >= 30000) level = 'R3 (30k)';
      else level = 'R2 (15k)';
      document.getElementById('currentProfitLevel').innerText = level;

      let nextTarget = 150000;
      if (netProfitNum < 30000) nextTarget = 30000;
      else if (netProfitNum < 50000) nextTarget = 50000;
      else if (netProfitNum < 80000) nextTarget = 80000;
      else nextTarget = 150000;
      document.getElementById('nextTargetDisplay').innerText = 'R ' + nextTarget.toLocaleString();
      const gap = nextTarget - netProfitNum;
      document.getElementById('gapText').innerText = gap > 0 ? `gap to next level: R ${gap.toLocaleString()}` : 'target reached!';
      const fillPercent = Math.min(100, (netProfitNum / nextTarget) * 100);
      document.getElementById('profitGapFill').style.width = fillPercent + '%';

      const feedPerBird = 4.5;
      const totalFeedKg = TOTAL_BIRDS * feedPerBird;
      const bags = totalFeedKg / 50;
      const feedCostEst = bags * 385;
      document.getElementById('totalFeedKg').innerText = totalFeedKg.toFixed(0) + ' kg';
      document.getElementById('feedBags').innerText = Math.ceil(bags) + ' bags';
      document.getElementById('feedCostEstimate').innerText = 'R ' + feedCostEst.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

      const vTrigger = parseFloat(vehicleTrigger.value) || 40000;
      document.getElementById('triggerSuggestions').innerHTML = `<p>ğŸš€ next: vehicle at R ${vTrigger.toLocaleString()}</p>`;
      document.getElementById('triggerProgress').innerText = `you are ${((netProfitNum/vTrigger)*100).toFixed(0)}% toward vehicle trigger`;

      document.getElementById('deathRateDisplay').innerText = (MORTALITY_RATE * 100).toFixed(1) + '%';
      document.getElementById('laborPerBird').innerText = 'R ' + (labor / TOTAL_BIRDS).toFixed(2);
      document.getElementById('profitPerWorker').innerText = 'R ' + (netProfit / 3).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

      document.getElementById('wholesaleVal').innerText = wholesalePct.value;
      document.getElementById('retailVal').innerText = retailPct.value;
      document.getElementById('restaurantVal').innerText = restaurantPct.value;

      updateRewardsUI();
    }

    const costInputs = [chicksInput, feedInput, transportInput, laborInput, utilitiesInput, equipmentInput, lossesInput, adjustableCostPerBird, wholesalePct, retailPct, restaurantPct, subDiscount, refDiscount, byproductPerBirdInput, vehicleTrigger, stockTrigger, farmTrigger];
    costInputs.forEach(inp => inp.addEventListener('input', updateAll));

    [enableRewardsChk, chickensPerRewardInp, streakDaysInp, rewardDiscountInp, doubleByproductChk, referralCreditInp].forEach(inp => {
      inp.addEventListener('change', () => {
        rewardSettings.enabled = enableRewardsChk.checked;
        rewardSettings.chickensPerReward = parseInt(chickensPerRewardInp.value) || 10;
        rewardSettings.streakDays = parseInt(streakDaysInp.value) || 7;
        rewardSettings.baseDiscount = parseFloat(rewardDiscountInp.value) || 8;
        rewardSettings.doubleByproduct = doubleByproductChk.checked;
        rewardSettings.referralCredit = parseFloat(referralCreditInp.value) || 50;
        updateAll();
      });
    });

    simulatePurchaseBtn.addEventListener('click', () => {
      const activeIdx = rewardsData.findIndex(r => r.status === 'active');
      if (activeIdx >= 0) {
        rewardsData[activeIdx].progress += 1;
        if (rewardsData[activeIdx].progress >= rewardsData[activeIdx].target) {
          rewardsData[activeIdx].status = 'claimed';
        }
      } else {
        rewardsData.push({ customerId: 999, name: 'New Customer', type: 'welcome', progress: 1, target: 3, status: 'active', expiry: '2025-04-20', discount: 8, byproductBoost: true, referralCredit: 0 });
      }
      updateAll();
    });

    updateAll();

    const growthBtns = document.querySelectorAll('[data-growth]');
    growthBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const growth = parseInt(btn.dataset.growth) / 100;
        const netProfit = parseFloat(document.getElementById('netMonthly').innerText.replace('R', '').replace(',', '')) || 86400;
        const projected = netProfit * 3 * (1 + growth);
        document.getElementById('projectedProfit').innerText = 'R ' + projected.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        document.getElementById('growthHint').innerText = `simulating +${btn.dataset.growth}% growth`;
      });
    });

    console.log('Luxury Poultry Dashboard â€” with 3-dots navigation + infra module + CRM pane');
  })();
</script>

<!-- INFRASTRUCTURE MODULE SCRIPT (additional, integrated) -->
<script>
  (function() {
    // Ensure infra elements exist before using
    const currentCapacity = document.getElementById('currentCapacity');
    if (!currentCapacity) return; // exit if infra pane not loaded

    const projectedDemand = document.getElementById('projectedDemand');
    const emergencyBalance = document.getElementById('emergencyBalance');
    const emergencyMin = document.getElementById('emergencyMin');
    const catEquipment = document.getElementById('catEquipment');
    const catTooling = document.getElementById('catTooling');
    const catLogistics = document.getElementById('catLogistics');
    const catPackaging = document.getElementById('catPackaging');
    const goalLand = document.getElementById('goalLand');
    const goalFacility = document.getElementById('goalFacility');
    const goalMachinery = document.getElementById('goalMachinery');
    const goalTimeline = document.getElementById('goalTimeline');
    const capacityUtil = document.getElementById('capacityUtilization');
    const infraSuggestion = document.getElementById('infraSuggestion');
    const requiredInvestment = document.getElementById('requiredInvestment');
    const upgradeDetails = document.getElementById('upgradeDetails');
    const emergencyAlert = document.getElementById('emergencyAlert');
    const catSum = document.getElementById('catSum');
    const availProfitSpan = document.getElementById('availProfit');
    const allocInfra = document.getElementById('allocInfra');
    const allocEmergency = document.getElementById('allocEmergency');
    const allocEquipment = document.getElementById('allocEquipment');
    const allocTooling = document.getElementById('allocTooling');
    const allocLogistics = document.getElementById('allocLogistics');
    const allocPackaging = document.getElementById('allocPackaging');
    const totalGoalsSpan = document.getElementById('totalGoals');
    const monthlyGoalReqSpan = document.getElementById('monthlyGoalReq');
    const profitAfterGoalsSpan = document.getElementById('profitAfterGoals');
    const rolloverSummary = document.getElementById('rolloverSummary');
    const yearEndAlert = document.getElementById('yearEndAlert');
    const infraNotifications = document.getElementById('infraNotifications');

    function getMonthlyNetProfit() {
      const netElem = document.getElementById('netMonthly');
      if (!netElem) return 86400;
      const text = netElem.innerText.replace('R', '').replace(/,/g, '').trim();
      return parseFloat(text) || 86400;
    }

    function validateCategorySum() {
      let e = parseFloat(catEquipment.value) || 0;
      let t = parseFloat(catTooling.value) || 0;
      let l = parseFloat(catLogistics.value) || 0;
      let p = parseFloat(catPackaging.value) || 0;
      let sum = e + t + l + p;
      catSum.innerText = `total ${sum}%`;
      catSum.style.color = (sum !== 100) ? '#b85a3a' : '#d4af37';
      return sum;
    }

    function updateInfraModule() {
      const profit = getMonthlyNetProfit();
      availProfitSpan.innerText = 'R ' + profit.toLocaleString();

      const cap = parseFloat(currentCapacity.value) || 0;
      const demand = parseFloat(projectedDemand.value) || 0;
      const util = cap ? (demand / cap) * 100 : 0;
      capacityUtil.innerText = util.toFixed(0) + '%';

      const needInfra = cap < demand;
      let infraAlloc = 0;
      if (needInfra) {
        infraAlloc = profit * 0.4;
        infraSuggestion.innerHTML = 'âš™ï¸ infrastructure upgrade active (40% of profit)';
        infraSuggestion.className = 'badge';
      } else {
        infraSuggestion.innerHTML = 'âœ… capacity sufficient â€“ no forced infra allocation';
        infraSuggestion.className = 'badge green-text';
      }

      let remaining = profit - infraAlloc;
      const emergBal = parseFloat(emergencyBalance.value) || 0;
      const emergMinVal = parseFloat(emergencyMin.value) || 0;
      const emergDeficit = Math.max(0, emergMinVal - emergBal);
      const emergTopUp = Math.min(emergDeficit, remaining * 0.3);
      remaining -= emergTopUp;

      let ePct = parseFloat(catEquipment.value) || 0;
      let tPct = parseFloat(catTooling.value) || 0;
      let lPct = parseFloat(catLogistics.value) || 0;
      let pPct = parseFloat(catPackaging.value) || 0;
      let sum = ePct + tPct + lPct + pPct;
      if (sum === 0) sum = 1;

      const allocE = (remaining * ePct) / sum;
      const allocT = (remaining * tPct) / sum;
      const allocL = (remaining * lPct) / sum;
      const allocP = (remaining * pPct) / sum;

      allocInfra.innerText = 'R ' + infraAlloc.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      allocEmergency.innerText = 'R ' + emergTopUp.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      allocEquipment.innerText = 'R ' + allocE.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      allocTooling.innerText = 'R ' + allocT.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      allocLogistics.innerText = 'R ' + allocL.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      allocPackaging.innerText = 'R ' + allocP.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

      if (needInfra) {
        const shortfall = demand - cap;
        const investPerBird = 150;
        const invest = shortfall * investPerBird;
        requiredInvestment.innerText = 'R ' + invest.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        upgradeDetails.innerText = `ğŸ”§ add ${shortfall} units, feeders, water, climate, tech`;
      } else {
        requiredInvestment.innerText = 'R 0';
        upgradeDetails.innerText = 'capacity meets demand';
      }

      if (emergBal < emergMinVal) {
        emergencyAlert.innerHTML = 'âš ï¸ below minimum!';
        emergencyAlert.className = 'badge alert-badge';
      } else {
        emergencyAlert.innerHTML = 'âœ… above minimum';
        emergencyAlert.className = 'badge';
      }

      const land = parseFloat(goalLand.value) || 0;
      const fac = parseFloat(goalFacility.value) || 0;
      const mach = parseFloat(goalMachinery.value) || 0;
      const totalGoals = land + fac + mach;
      totalGoalsSpan.innerText = 'R ' + totalGoals.toLocaleString();
      const months = parseFloat(goalTimeline.value) || 1;
      const monthlyReq = totalGoals / months;
      monthlyGoalReqSpan.innerText = 'R ' + monthlyReq.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      const profitAfter = profit - monthlyReq;
      profitAfterGoalsSpan.innerText = 'R ' + profitAfter.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

      let notifHtml = '';
      if (util > 80) notifHtml += '<p class="badge alert-badge">âš ï¸ capacity nearing limit (consider upgrade)</p>';
      if (emergBal < emergMinVal) notifHtml += '<p class="badge alert-badge">âš ï¸ emergency fund below minimum</p>';
      if (needInfra) notifHtml += '<p class="badge">ğŸ“ˆ infrastructure investment suggested</p>';
      infraNotifications.innerHTML = notifHtml || '<p class="badge">âœ… all systems nominal</p>';
    }

    function simulateYearEnd() {
      const emergBal = parseFloat(emergencyBalance.value) || 0;
      const emergMinVal = parseFloat(emergencyMin.value) || 0;
      const unused = Math.max(0, emergBal - emergMinVal);
      if (unused > 0) {
        const reinvest = unused * 0.4;
        const rollover = unused * 0.6;
        const newBalance = emergMinVal + rollover;
        emergencyBalance.value = newBalance.toFixed(0);
        rolloverSummary.innerHTML = `ğŸ”„ reinvested R ${reinvest.toFixed(0)} into infrastructure/equipment/tooling Â· R ${rollover.toFixed(0)} rolled over`;
        yearEndAlert.innerHTML = 'âœ… yearâ€‘end rollover applied';
      } else {
        rolloverSummary.innerHTML = 'âš ï¸ no unused emergency funds to roll over';
        yearEndAlert.innerHTML = '';
      }
      updateInfraModule();
    }

    // Attach listeners
    [currentCapacity, projectedDemand, emergencyBalance, emergencyMin,
     catEquipment, catTooling, catLogistics, catPackaging,
     goalLand, goalFacility, goalMachinery, goalTimeline].forEach(el => {
      el.addEventListener('input', () => { validateCategorySum(); updateInfraModule(); });
    });

    document.getElementById('recalcAllocBtn').addEventListener('click', updateInfraModule);
    document.getElementById('simulateYearEndBtn').addEventListener('click', simulateYearEnd);

    // Observe profit changes
    const profitObserver = new MutationObserver(updateInfraModule);
    const netMonthlyEl = document.getElementById('netMonthly');
    if (netMonthlyEl) profitObserver.observe(netMonthlyEl, { childList: true, characterData: true, subtree: true });

    validateCategorySum();
    updateInfraModule();
  })();
</script>

<!-- CRM pane minor interactivity (optional) -->
<script>
  (function() {
    const crmPane = document.getElementById('crmPane');
    if (!crmPane) return;
    // Quick action buttons (simple console feedback)
    crmPane.querySelectorAll('.quick-action-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        alert(`ğŸ”§ ${btn.innerText} clicked (demo)`);
      });
    });
    // Filter chips (toggle active)
    crmPane.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        chip.classList.toggle('active');
      });
    });
  })();
</script>

<!-- backend notes extended -->
</body>
</html>